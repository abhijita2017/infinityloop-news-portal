name: Deploy Laravel App (Fixed for DB-dependent apps)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, json, mysql, pdo, pdo_mysql, curl, gd, zip
    
    - name: Install dependencies (skip scripts that need DB)
      run: |
        composer install --no-scripts --no-interaction --prefer-dist --optimize-autoloader
        echo "âœ… Dependencies installed (scripts skipped - will run on EC2)"
    
    - name: Generate optimized autoload (without package discovery)
      run: |
        composer dump-autoload --no-scripts
        echo "âœ… Autoload optimized"
    
    - name: Verify installation
      run: |
        if [ -f "artisan" ]; then
          echo "âœ… Laravel application structure verified"
        else
          echo "âŒ Not a valid Laravel application"
          exit 1
        fi

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, json, mysql, pdo, pdo_mysql, curl, gd, zip
    
    - name: Install dependencies (no scripts)
      run: composer install --no-scripts --no-interaction --prefer-dist --optimize-autoloader
    
    - name: Create deployment package
      run: |
        echo "ðŸ“¦ Creating deployment package..."
        tar -czf deployment.tar.gz \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='node_modules' \
          --exclude='.env.backup' \
          --exclude='tests' \
          --exclude='storage/logs/*' \
          --exclude='storage/framework/cache/*' \
          --exclude='storage/framework/sessions/*' \
          --exclude='storage/framework/views/*' \
          .
        echo "âœ… Package created"
    
    - name: Deploy to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "deployment.tar.gz"
        target: "/tmp/"
    
    - name: Configure and run application on EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          
          APP_NAME="${{ github.event.repository.name }}"
          APP_DIR="/var/www/${APP_NAME}"
          
          echo "ðŸš€ Deploying ${APP_NAME}..."
          
          # Create application directory
          sudo mkdir -p ${APP_DIR}
          
          # Extract deployment package
          echo "ðŸ“‚ Extracting files..."
          sudo tar -xzf /tmp/deployment.tar.gz -C ${APP_DIR}
          
          # Set permissions
          echo "ðŸ”’ Setting permissions..."
          sudo chown -R www-data:www-data ${APP_DIR}
          sudo chmod -R 755 ${APP_DIR}
          sudo chmod -R 775 ${APP_DIR}/storage ${APP_DIR}/bootstrap/cache
          
          # Create .env file
          echo "âš™ï¸  Creating .env file..."
          sudo tee ${APP_DIR}/.env > /dev/null <<'EOF'
          APP_NAME="${{ github.event.repository.name }}"
          APP_ENV=production
          APP_DEBUG=false
          APP_URL=http://${{ github.event.repository.name }}.infinityloop.com
          
          DB_CONNECTION=mysql
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=3306
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          BROADCAST_DRIVER=log
          CACHE_DRIVER=file
          FILESYSTEM_DISK=local
          QUEUE_CONNECTION=sync
          SESSION_DRIVER=file
          SESSION_LIFETIME=120
          
          MEMCACHED_HOST=127.0.0.1
          
          REDIS_HOST=127.0.0.1
          REDIS_PASSWORD=null
          REDIS_PORT=6379
          
          MAIL_MAILER=smtp
          MAIL_HOST=mailpit
          MAIL_PORT=1025
          MAIL_USERNAME=null
          MAIL_PASSWORD=null
          MAIL_ENCRYPTION=null
          MAIL_FROM_ADDRESS="hello@example.com"
          MAIL_FROM_NAME="${APP_NAME}"
          
          AWS_ACCESS_KEY_ID=
          AWS_SECRET_ACCESS_KEY=
          AWS_DEFAULT_REGION=us-east-1
          AWS_BUCKET=
          AWS_USE_PATH_STYLE_ENDPOINT=false
          
          PUSHER_APP_ID=
          PUSHER_APP_KEY=
          PUSHER_APP_SECRET=
          PUSHER_HOST=
          PUSHER_PORT=443
          PUSHER_SCHEME=https
          PUSHER_APP_CLUSTER=mt1
          
          VITE_APP_NAME="${APP_NAME}"
          VITE_PUSHER_APP_KEY="${PUSHER_APP_KEY}"
          VITE_PUSHER_HOST="${PUSHER_HOST}"
          VITE_PUSHER_PORT="${PUSHER_PORT}"
          VITE_PUSHER_SCHEME="${PUSHER_SCHEME}"
          VITE_PUSHER_APP_CLUSTER="${PUSHER_APP_CLUSTER}"
          EOF
          
          # Generate application key
          echo "ðŸ”‘ Generating application key..."
          cd ${APP_DIR}
          sudo -u www-data php artisan key:generate --force
          
          # Now run composer scripts with database available
          echo "ðŸ”§ Running composer scripts..."
          sudo -u www-data composer dump-autoload --optimize
          
          # Run migrations
          echo "ðŸ“Š Running database migrations..."
          sudo -u www-data php artisan migrate --force || echo "âš ï¸  Migrations skipped (may not be needed)"
          
          # Clear and optimize
          echo "âš¡ Optimizing application..."
          sudo -u www-data php artisan config:cache
          sudo -u www-data php artisan route:cache
          sudo -u www-data php artisan view:cache
          
          # Create Nginx configuration
          echo "ðŸŒ Configuring Nginx..."
          NGINX_CONF="/etc/nginx/sites-available/$(echo ${APP_NAME} | sed 's/infinityloop-//')"
          sudo tee ${NGINX_CONF} > /dev/null <<'NGINX'
          server {
              listen 80;
              server_name ${{ github.event.repository.name }}.infinityloop.com;
              
              root /var/www/${{ github.event.repository.name }}/public;
              index index.php index.html;
              
              access_log /var/log/nginx/$(echo ${{ github.event.repository.name }} | sed 's/infinityloop-//')-access.log;
              error_log /var/log/nginx/$(echo ${{ github.event.repository.name }} | sed 's/infinityloop-//')-error.log;
              
              location / {
                  try_files \$uri \$uri/ /index.php?\$query_string;
              }
              
              location ~ \.php$ {
                  include snippets/fastcgi-php.conf;
                  fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
                  fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
                  include fastcgi_params;
              }
              
              location ~ /\.ht {
                  deny all;
              }
              
              location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
                  expires 365d;
                  add_header Cache-Control "public, immutable";
              }
          }
          NGINX
          
          # Enable site and reload Nginx
          sudo ln -sf ${NGINX_CONF} /etc/nginx/sites-enabled/
          sudo nginx -t && sudo systemctl reload nginx
          
          # Clean up
          rm -f /tmp/deployment.tar.gz
          
          echo "âœ… Deployment completed successfully!"
    
    - name: Deployment Status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Deployment successful!"
        else
          echo "âŒ Deployment failed!"
        fi
